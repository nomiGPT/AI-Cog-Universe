name: Build & Push backend image to Dockerhub and deploy on Elastic Beanstalk
on:
  push:
    branches:
      - master
    paths:
        - 'packages/backend/**'
        - 'packages/shared/**'
        - 'package.json'
        - 'backend.Dockerfile'
        - 'Dockerrun.aws.json'
        - '.github/workflows/deploy-backend.yml'
        - 'package.json'
        - 'package-lock.json'
jobs:
  build_docker_images:
    name: Build/Push Docker Image and Deploy to Elastic Beanstalk
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKERHUB_USERNAME}}
          password: ${{secrets.DOCKERHUB_TOKEN}}
          logout: true
      - name: Build Docker Backend Image
        run: docker build -t ${{ secrets.DOCKERHUB_BACKEND_REPO }} -f
          ./backend.Dockerfile .
      - name: Tag Our Image
        run: docker tag ${{ secrets.DOCKERHUB_BACKEND_REPO }}
          ${{ secrets.DOCKERHUB_BACKEND_REPO }}:${{ github.sha }}
      - name: Push to DockerHub
        run: docker push ${{ secrets.DOCKERHUB_BACKEND_REPO }}:${{ github.sha }}
      - name: Prepare Beanstalk Deployment Package
        run: |
          echo 'Replacing TAG in Dockerrun.aws.json...'
          sed -i -e "s|<DOCKERHUB_REPO>|$DOCKERHUB_REPO|g" Dockerrun.aws.json
          sed -i -e "s|<TAG>|$SHA|g" Dockerrun.aws.json
          sed -i -e "s|<CONTAINER_PORT>|$CONTAI